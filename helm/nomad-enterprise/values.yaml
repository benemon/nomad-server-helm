# Default values for nomad-enterprise-server

# Number of Nomad server replicas
replicaCount: 1

# Nomad image configuration
image:
  # repository: quay.io/benjamin_holmes/nomad-enterprise-server
  repository: docker.io/hashicorp/nomad
  pullPolicy: Always
  #tag: "main"
  tag: 1.11-ent

imagePullSecrets: []

# Namespace creation
namespaceCreate: true
namespace: nomad

# Nomad Enterprise license
# Provide via: --set license=<your-license-string>
# Or: --set-file license=/path/to/license.hclic
license: ""

# Gossip encryption configuration
gossip:
  # Leave empty to auto-generate
  # Or provide your own base64-encoded 32-byte key
  key: ""

# Service configuration
service:
  # Headless service for StatefulSet (always created)
  headless:
    name: nomad-enterprise

  # Internal ClusterIP service for API/UI (backend for Route)
  internal:
    name: nomad-internal
    type: ClusterIP
    port: 4646

  # External LoadBalancer service for HTTP/API + RPC
  external:
    name: nomad-external
    type: LoadBalancer
    loadBalancerIP: ""  # Set this to a fixed IP from your MetalLB pool (e.g., 172.16.101.20)
    annotations: {}

# OpenShift-specific configuration
openshift:
  enabled: true
  route:
    enabled: true
    host: ""  # Leave empty for auto-generated, or specify custom hostname
    tls:
      termination: edge  # edge, passthrough, or reencrypt
      insecureEdgeTerminationPolicy: Redirect
  # Monitoring integration (ServiceMonitor and PrometheusRule)
  monitoring:
    enabled: true
    serviceMonitor:
      interval: 30s
      scrapeTimeout: 10s
      # Additional labels to match your Prometheus selector
      additionalLabels: {}
    prometheusRule:
      enabled: false  # Opt-in alerting rules
      # Custom rules can be added here
      rules: []

# Advertise configuration
# REQUIRED: Set this to the same IP/hostname as service.external.loadBalancerIP
advertise:
  address: ""  # Must match service.external.loadBalancerIP (e.g., 172.16.101.20)

# ServiceAccount configuration
serviceAccount:
  create: true
  name: ""  # Auto-generated if empty
  annotations: {}

# Storage configuration
persistence:
  enabled: true
  storageClass: ""  # Empty means use cluster default
  size: 10Gi
  accessMode: ReadWriteOnce
  # Separate PVC for audit logs (HVD requirement)
  audit:
    enabled: true
    storageClass: ""  # Empty means use cluster default
    size: 5Gi
    accessMode: ReadWriteOnce

# Resource limits and requests
resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Security context for OpenShift SCC compatibility
securityContext:
  runAsNonRoot: true
  # OpenShift assigns arbitrary UID
  # fsGroup is managed by OpenShift

# Nomad server configuration
server:
  # TLS configuration (disabled for PoC)
  tls:
    enabled: false
    # When enabled, provide cert paths
    # caCert: ""
    # serverCert: ""
    # serverKey: ""

  # ACL configuration
  acl:
    enabled: false  # Disabled by default - enable manually and bootstrap via CLI

  # Autopilot configuration
  autopilot:
    cleanupDeadServers: true
    lastContactThreshold: "200ms"
    maxTrailingLogs: 250
    serverStabilizationTime: "10s"
    enableRedundancyZones: false  # Simplified for StatefulSet
    disableUpgradeMigration: false
    enableCustomUpgrades: false

  # Audit logging configuration (HVD requirement)
  audit:
    enabled: true
    sink:
      type: file
      format: json
      path: /nomad/audit/audit.log
      deliveryGuarantee: enforced
      rotateDuration: "24h"
      rotateMaxFiles: 15

  # Snapshot agent configuration (HVD requirement)
  # Requires Nomad Enterprise and S3-compatible storage
  snapshot:
    enabled: false
    interval: "1h"
    retain: 24
    staleReads: true
    # S3-compatible storage (e.g., ODF RGW, MinIO)
    s3:
      endpoint: ""  # e.g., https://s3.openshift-storage.svc:443
      bucket: "nomad-snapshots"
      region: "us-east-1"
      forcePathStyle: true  # Required for most S3-compatible storage
      # Reference to existing secret with access-key-id and secret-access-key keys
      existingSecret: ""

  # Additional Nomad configuration (raw HCL)
  # Merged with server.hcl as /nomad/config/90-custom.hcl
  # Use --set-file server.extraConfig=./custom.hcl to load from file
  extraConfig: ""

# Pod anti-affinity for high availability
# Ensures Nomad server pods are spread across different nodes
affinity:
  podAntiAffinity:
    enabled: true
    # Use "preferred" (soft) or "required" (hard) anti-affinity
    # "preferred" allows scheduling on same node if necessary
    # "required" will fail if not enough nodes are available
    type: preferred
    # Weight for preferred anti-affinity (1-100)
    weight: 100
    # Topology key for spreading pods
    topologyKey: kubernetes.io/hostname

# Topology spread constraints for distributing pods across failure domains
# More flexible than pod anti-affinity for multi-zone clusters
topologySpreadConstraints:
  enabled: true
  constraints:
    # Spread across nodes
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels: {}  # Will be populated with nomad.selectorLabels
    # Uncomment for zone spreading (requires nodes with zone labels)
    # - maxSkew: 1
    #   topologyKey: topology.kubernetes.io/zone
    #   whenUnsatisfiable: ScheduleAnyway
    #   labelSelector:
    #     matchLabels: {}

# Node selector for scheduling
nodeSelector: {}

# Tolerations for scheduling
tolerations: []

# Additional labels
labels: {}

# Additional annotations
annotations: {}
