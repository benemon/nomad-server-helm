{{- /* Validate required fields */ -}}
{{- if not .Values.nomad.address }}
{{- fail "nomad.address is required" }}
{{- end }}
{{- include "snapshot-agent.validateStorage" . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "snapshot-agent.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "snapshot-agent.labels" . | nindent 4 }}
data:
  snapshot.hcl: |
    # Nomad Snapshot Agent Configuration
    # Generated by Helm chart {{ .Chart.Name }}-{{ .Chart.Version }}

    snapshot {
      interval         = "{{ .Values.schedule.interval }}"
      retain           = {{ .Values.schedule.retain }}
      stale            = {{ .Values.schedule.stale }}
      deregister_after = "8h"
    }

    {{- if .Values.storage.s3.enabled }}
    # S3 Storage Backend
    aws_s3 {
      bucket              = "{{ .Values.storage.s3.bucket }}"
      region              = "{{ .Values.storage.s3.region }}"
      {{- if .Values.storage.s3.endpoint }}
      endpoint            = "{{ .Values.storage.s3.endpoint }}"
      {{- end }}
      s3_force_path_style = {{ .Values.storage.s3.forcePathStyle }}
    }
    {{- end }}

    {{- if .Values.storage.gcs.enabled }}
    # Google Cloud Storage Backend
    google_cloud_storage {
      bucket = "{{ .Values.storage.gcs.bucket }}"
    }
    {{- end }}

    {{- if .Values.storage.azure.enabled }}
    # Azure Blob Storage Backend
    azure_blob_storage {
      container_name = "{{ .Values.storage.azure.container }}"
      account_name   = "{{ .Values.storage.azure.accountName }}"
    }
    {{- end }}

    {{- if .Values.storage.local.enabled }}
    # Local Storage Backend
    local_storage {
      path = "{{ .Values.storage.local.path }}"
    }
    {{- end }}
